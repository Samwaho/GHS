// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../trpc/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
}

enum GiftVoucherStatus {
  ACTIVE
  USED
  EXPIRED
  CANCELLED
}

enum GiftVoucherType {
  FIXED_AMOUNT // Fixed monetary value
  PERCENTAGE // Percentage discount
  SERVICE_SPECIFIC // Specific service voucher
}

model User {
  id                    String                 @id @default(cuid())
  name                  String?
  email                 String                 @unique
  password              String?
  emailVerified         DateTime?
  image                 String?
  accounts              Account[]
  role                  Role                   @default(USER)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  isTwoFactorEnabled    Boolean                @default(false)
  twoFactorConfirmation TwoFactorConfirmation?

  // User bookings
  bookings Booking[]

  // Admin created services
  createdServices Service[] @relation("ServiceCreator")

  // Gift vouchers
  purchasedGiftVouchers       GiftVoucher[]         @relation("GiftVoucherPurchaser")
  receivedGiftVouchers        GiftVoucher[]         @relation("GiftVoucherRecipient")
  createdGiftVoucherTemplates GiftVoucherTemplate[] @relation("GiftVoucherTemplateCreator")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorConfirmation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
}

// Service Categories
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Services in this category
  services Service[]

  @@map("categories")
}

// Branch/Location
model Branch {
  id        String   @id @default(cuid())
  name      String   @unique
  address   String
  city      String
  phone     String?
  email     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Services offered at this branch
  branchServices BranchService[]

  // Bookings at this branch
  bookings Booking[]

  @@map("branches")
}

// Services
model Service {
  id          String        @id @default(cuid())
  title       String
  description String?
  duration    Int // Duration in minutes
  basePrice   Float // Base price (can be overridden per branch)
  categoryId  String
  status      ServiceStatus @default(ACTIVE)
  image       String? // Service image
  isPopular   Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  category             Category              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  branchServices       BranchService[]
  bookings             Booking[]
  createdBy            User                  @relation("ServiceCreator", fields: [createdById], references: [id])
  createdById          String
  giftVoucherTemplates GiftVoucherTemplate[]

  @@map("services")
}

// Branch-specific service pricing and availability
model BranchService {
  id          String   @id @default(cuid())
  branchId    String
  serviceId   String
  price       Float // Branch-specific price
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  branch   Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  service  Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@unique([branchId, serviceId])
  @@map("branch_services")
}

// Bookings
model Booking {
  id              String        @id @default(cuid())
  userId          String
  serviceId       String
  branchId        String
  branchServiceId String
  scheduledAt     DateTime // Date and time of appointment
  status          BookingStatus @default(PENDING)
  totalPrice      Float // Final price including any adjustments
  notes           String? // Customer notes
  adminNotes      String? // Admin/internal notes
  attachmentUrl   String? // Uploadcare attachment URL
  attachmentUuid  String? // Uploadcare attachment UUID for management
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  service           Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  branch            Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  branchService     BranchService      @relation(fields: [branchServiceId], references: [id], onDelete: Cascade)
  giftVoucherUsages GiftVoucherUsage[]

  @@map("bookings")
}

// Gallery for displaying images
model Gallery {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String // Uploadcare image URL
  imageUuid   String? // Uploadcare image UUID for management
  order       Int      @default(0) // For ordering images
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("gallery")
}

// Gift Voucher Templates (Admin creates these)
model GiftVoucherTemplate {
  id                String          @id @default(cuid())
  name              String // e.g., "Spa Day Package", "50% Off Massage"
  description       String?
  type              GiftVoucherType // FIXED_AMOUNT, PERCENTAGE, SERVICE_SPECIFIC
  value             Float // Amount or percentage value (what the voucher is worth)
  price             Float // Price to purchase the voucher
  serviceId         String? // For SERVICE_SPECIFIC type
  isActive          Boolean         @default(true)
  validityDays      Int             @default(365) // How many days the voucher is valid
  maxUsageCount     Int? // Max times this template can be used (null = unlimited)
  currentUsageCount Int             @default(0)
  imageUrl          String? // Optional voucher image
  imageUuid         String? // Uploadcare image UUID
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  service      Service?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  createdBy    User          @relation("GiftVoucherTemplateCreator", fields: [createdById], references: [id])
  createdById  String
  giftVouchers GiftVoucher[]

  @@map("gift_voucher_templates")
}

// Individual Gift Vouchers (Purchased by users)
model GiftVoucher {
  id             String            @id @default(cuid())
  code           String            @unique // Unique voucher code
  templateId     String
  purchasedById  String // Who bought the voucher
  recipientId    String? // Who received the voucher (can be same as purchaser)
  recipientEmail String? // Email of recipient if not a registered user
  recipientName  String? // Name of recipient
  status         GiftVoucherStatus @default(ACTIVE)
  originalValue  Float // Original value of the voucher
  remainingValue Float // Remaining value (for partial usage)
  purchasePrice  Float // What was paid for this voucher
  expiresAt      DateTime // When the voucher expires
  usedAt         DateTime? // When the voucher was fully used
  message        String? // Personal message from purchaser
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  template    GiftVoucherTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  purchasedBy User                @relation("GiftVoucherPurchaser", fields: [purchasedById], references: [id])
  recipient   User?               @relation("GiftVoucherRecipient", fields: [recipientId], references: [id])
  usages      GiftVoucherUsage[]

  @@map("gift_vouchers")
}

// Track voucher usage
model GiftVoucherUsage {
  id         String   @id @default(cuid())
  voucherId  String
  bookingId  String? // If used for a booking
  amountUsed Float // Amount deducted from voucher
  usedAt     DateTime @default(now())
  notes      String? // Additional notes about usage

  // Relations
  voucher GiftVoucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  booking Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@map("gift_voucher_usages")
}

model HomeContent {
  id        String   @id @default(cuid())
  slug      String   @unique
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("home_content")
}
